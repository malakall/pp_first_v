# Heatmap ML Service

Сервис для построения **тепловых карт движения людей по видео**.  
Пользователь загружает видео → в фоне оно обрабатывается ML-моделью (YOLOv8) → на выходе получается картинка с тепловой картой поверх среднего фона кадра.

---

##  Что умеет проект

-  Регистрация / логин пользователя (JWT, токен хранится в HttpOnly cookie)
-  Загрузка видео (`.mp4 / .avi / .mov`)
-  Детекция людей на кадрах с помощью **YOLOv8**
-  Построение тепловой карты по траекториям людей
-  Асинхронная обработка задач через **Celery + Redis** дабы задчка висела в фоне
-  Сохранение истории тепловых карт пользователя в **PostgreSQL**
-  Получение списка всех тепловых карт для текущего пользователя

---

##  Стек технологий

**Backend / ML:**
- Python 3.12
- FastAPI
- Celery
- Redis (broker + result backend)
- PostgreSQL
- SQLAlchemy + Alembic
- python-jose, passlib (JWT, но только на accsess)
- ultralytics (YOLOv8)
- opencv-python-headless
- NumPy

**Инфраструктура:**
- Docker
- Docker Compose

(Фронтенд можно подключить отдельно — React/Vite, обращаясь к API FastAPI.)

---

##  Архитектура (в двух словах)

- **FastAPI**:
  - принимает запросы от клиента,
  - сохраняет загруженное видео в директорию `videos/`,
  - создаёт задачу Celery и возвращает пользователю `task_id`,
  - по `task_id` отдаёт статус или готовую тепловую карту.

- **Celery worker**:
  - слушает очередь задач в **Redis**,
  - забирает задачу (имя файла видео),
  - обрабатывает видео: кадры → YOLO → накопление heatmap → сохранение `*_heatmap.jpg` в `heatmaps/`,
  - сохраняет результат и статус задачи в Redis (result backend).

- **PostgreSQL**:
  - хранит пользователей,
  - хранит таблицу `heatmaps` (user_id, task_id, имена файлов, created_at).

- **Redis**:
  - брокер задач для Celery,
  - хранилище статусов и результатов задач.

Общие директории для backend и worker монтируются как Docker volume:

- `./videos` ↔ `/app/videos`
- `./heatmaps` ↔ `/app/heatmaps`

---

## Структура проекта:

```bash
pp_first_v/                         # Корень проекта
├── README.md                       # Общая документация по проекту
├── docker-compose.yml              # Описание сервисов (backend, frontend, БД, Redis и т.п.)
├── backend/                        # Серверная часть (API, БД, миграции)
│   ├── Dockerfile                  # Образ backend'а для Docker
│   ├── alembic.ini                 # Конфиг Alembic для миграций БД
│   ├── requirements.txt            # Python-зависимости backend'а
│   ├── app/                        # Исходный код backend-приложения
│   │   ├── main.py                 # Точка входа FastAPI-приложения
│   │   ├── database.py             # Подключение к БД, движок и сессии SQLAlchemy
│   │   ├── exceptions.py           # Кастомные исключения и обработчики ошибок
│   │   ├── dao/                    # Слой доступа к данным (репозитории/CRUD)
│   │   ├── ml/                     # ML-логика: модели, инференс, обработка данных
│   │   ├── users/                  # Логика, схемы и маршруты, связанные с пользователями
│   │   └── __pycache__/            # Служебные файлы Python (игнорируются)
│   ├── migrations/                 # Миграции Alembic
│   │   ├── README                  # Краткая дока по работе с миграциями
│   │   ├── env.py                  # Главный конфиг Alembic (подключение к БД, таргеты)
│   │   ├── script.py.mako          # Шаблон автогенерации миграций
│   │   ├── versions/               # Конкретные версии миграций (скрипты изменения схемы)
│   │   └── __pycache__/            # Служебные файлы Python
├── frontend/                       # Клиентская часть (React + TypeScript)
│   ├── Dockerfile                  # Образ frontend'а для Docker
│   ├── README.md                   # Документация по frontend'у
│   ├── package.json                # Скрипты и зависимости NPM
│   ├── package-lock.json           # Зафиксированные версии зависимостей
│   ├── index.html                  # HTML-шаблон для Vite-приложения
│   ├── vite.config.ts              # Конфиг Vite
│   ├── tsconfig.json               # Общие настройки TypeScript
│   ├── tsconfig.app.json           # TS-конфиг для приложения
│   ├── tsconfig.node.json          # TS-конфиг для node-среды (инструменты/скрипты)
│   ├── public/                     # Публичные статические файлы
│   │   └── vite.svg                # Логотип/иконка по умолчанию Vite
│   └── src/                        # Исходный код фронтенда
│       ├── main.tsx                # Точка входа React-приложения
│       ├── App.tsx                 # Корневой компонент приложения
│       ├── App.css                 # Стили для App
│       ├── index.css               # Глобальные стили
│       ├── AuthContext.tsx         # Контекст авторизации (пользователь, токены, guard)
│       ├── api.ts                  # Клиент для запросов к backend API
│       ├── assets/                 # Статические ресурсы (картинки, иконки и т.п.)
│       ├── components/             # Переиспользуемые UI-компоненты
│       └── pages/                  # Страницы приложения (роуты)
├── heatmaps/                       # Генерируемые тепловые карты (результаты анализа)
└── videos/                         # Видеофайлы (сырые/обработанные ролики)
    

```

---

## Запуск нашего проекта

### 1. Требования

Нужно в директории `./backend` переименовать `.env.example`, а другие переменные окружения уже прописаны в `docker-compose.yml`(знаю, что так не оч правильно делать).

---

### 2. Запустить все сервисы

Из корня проекта:

```bash
docker compose up --build
```

### 3. Прогнать миграции, дабы создались в бдшке таблички

```bash
docker exec -it "название контенейра" bash
```

```bash
alembic revision --autogenerate -m "new" && alembic upgrade head
```

